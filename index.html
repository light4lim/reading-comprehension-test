<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reading Comprehension Test - Year 9</title>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    
    <script>
        (function() {
            if (typeof React === 'undefined' || typeof ReactDOM === 'undefined') {
                document.getElementById('root').innerHTML = '<div style="padding: 20px; text-align: center;"><h1>Loading error</h1><p>Please refresh the page</p></div>';
                return;
            }
            
            const e = React.createElement;
            const { useState, useEffect } = React;
        
        // Simple SVG Icons
        const Icon = (props) => {
            const { path, ...rest } = props;
            return e('svg', {
                xmlns: "http://www.w3.org/2000/svg",
                width: 24,
                height: 24,
                viewBox: "0 0 24 24",
                fill: "none",
                stroke: "currentColor",
                strokeWidth: 2,
                ...rest
            }, e('path', { d: path }));
        };

        function ReadingQuizApp() {
            const [stage, setStage] = useState('start');
            const [passage, setPassage] = useState(null);
            const [answers, setAnswers] = useState({});
            const [startTime, setStartTime] = useState(null);
            const [elapsedTime, setElapsedTime] = useState(0);
            const [score, setScore] = useState(null);
            const [showTeacherMode, setShowTeacherMode] = useState(false);
            const [teacherPassword, setTeacherPassword] = useState('');
            const [isTeacherAuthenticated, setIsTeacherAuthenticated] = useState(false);
            const [testHistory, setTestHistory] = useState([]);
            const [showHistory, setShowHistory] = useState(false);

            const TEACHER_PASSWORD = 'teacher123';

            useEffect(() => {
                const saved = localStorage.getItem('testHistory');
                if (saved) {
                    try {
                        setTestHistory(JSON.parse(saved));
                    } catch (err) {
                        console.error('Error loading history');
                    }
                }
            }, []);

            const saveHistory = (historyData) => {
                localStorage.setItem('testHistory', JSON.stringify(historyData));
                setTestHistory(historyData);
            };

            useEffect(() => {
                let interval;
                if (stage === 'quiz' && startTime) {
                    interval = setInterval(() => {
                        setElapsedTime(Math.floor((Date.now() - startTime) / 1000));
                    }, 1000);
                }
                return () => clearInterval(interval);
            }, [stage, startTime]);

            const formatTime = (seconds) => {
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return mins + ':' + String(secs).padStart(2, '0');
            };

            const formatDate = (timestamp) => {
                return new Date(timestamp).toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            };

            const generatePassage = async () => {
                setStage('loading');
                
                const prompt = "Generate a comprehensive reading passage with exactly 25 questions. CRITICAL: Respond with ONLY valid JSON. No markdown, no backticks. Structure: {title, passage: {introduction, sections: [{subtitle, content}], conclusion}, questions: [{id, category, question, options: [4 options], correctAnswer: letter, explanation}], vocabulary: [{term, definition}]}. Requirements: 25 questions (Reading Comprehension 8-9, Vocabulary 5-6, Critical Thinking 6-7, Mathematical Reasoning 4-5), correctAnswer must be a/b/c/d, 15-20 vocab terms, Year 9 level. RESPOND ONLY WITH JSON.";

                try {
                    const response = await fetch("https://api.anthropic.com/v1/messages", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            model: "claude-sonnet-4-20250514",
                            max_tokens: 6000,
                            messages: [{ role: "user", content: prompt }]
                        })
                    });

                    const data = await response.json();
                    let text = data.content[0].text.replace(/```json\n?/g, "").replace(/```\n?/g, "").trim();
                    const passageData = JSON.parse(text);
                    
                    setPassage(passageData);
                    setStage('quiz');
                    setStartTime(Date.now());
                } catch (error) {
                    alert('Error generating test. Please try again.');
                    setStage('start');
                }
            };

            const handleAnswerChange = (questionId, answer) => {
                setAnswers(prev => ({ ...prev, [questionId]: answer }));
            };

            const handleSubmit = () => {
                const totalQuestions = passage.questions.length;
                let correctCount = 0;
                
                passage.questions.forEach(q => {
                    if (answers[q.id] === q.correctAnswer) correctCount++;
                });

                const scoreData = {
                    correct: correctCount,
                    total: totalQuestions,
                    percentage: Math.round((correctCount / totalQuestions) * 100)
                };

                setScore(scoreData);

                const historyEntry = {
                    id: Date.now(),
                    timestamp: Date.now(),
                    title: passage.title,
                    score: scoreData,
                    timeTaken: elapsedTime,
                    passage: passage,
                    userAnswers: answers
                };

                saveHistory([historyEntry, ...testHistory]);
                setStage('results');
            };

            const handleTeacherLogin = () => {
                if (teacherPassword === TEACHER_PASSWORD) {
                    setIsTeacherAuthenticated(true);
                    setShowTeacherMode(false);
                    setTeacherPassword('');
                    setShowHistory(true);
                }
            };

            const viewHistoryTest = (test) => {
                setPassage(test.passage);
                setAnswers(test.userAnswers);
                setScore(test.score);
                setElapsedTime(test.timeTaken);
                setShowHistory(false);
                setStage('results');
            };

            const deleteHistoryTest = (testId) => {
                if (window.confirm("Delete this test?")) {
                    saveHistory(testHistory.filter(t => t.id !== testId));
                }
            };

            const exportToJSON = () => {
                const dataStr = JSON.stringify(testHistory, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'reading-tests-' + new Date().toISOString().split('T')[0] + '.json';
                link.click();
                URL.revokeObjectURL(url);
            };

            const importFromJSON = (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (evt) => {
                        try {
                            const imported = JSON.parse(evt.target.result);
                            if (Array.isArray(imported)) {
                                saveHistory([...imported, ...testHistory]);
                                alert('Imported ' + imported.length + ' tests!');
                            }
                        } catch (error) {
                            alert('Invalid JSON file');
                        }
                    };
                    reader.readAsText(file);
                }
            };

            // Start screen
            if (stage === 'start') {
                return e('div', { className: "min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4 flex items-center justify-center" },
                    e('div', { className: "bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full text-center" },
                        e('div', { className: "flex justify-end mb-2" },
                            e('button', {
                                onClick: () => setShowTeacherMode(true),
                                className: "text-sm text-gray-600 hover:text-indigo-600 px-3 py-1 rounded hover:bg-gray-100"
                            }, 'ðŸ‘¨â€ðŸ« Teacher')
                        ),
                        e('div', { className: "text-6xl mb-4" }, 'ðŸ“–'),
                        e('h1', { className: "text-3xl font-bold text-gray-800 mb-4" }, "Reading Test"),
                        e('p', { className: "text-gray-600 mb-8" }, "AI generates 25 questions on random topics. Year 9 level (20-30 seconds)"),
                        e('button', {
                            onClick: generatePassage,
                            className: "w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-4 px-6 rounded-lg mb-4"
                        }, "Generate New Test"),
                        testHistory.length > 0 && e('button', {
                            onClick: () => setShowHistory(true),
                            className: "w-full bg-gray-100 hover:bg-gray-200 text-gray-800 font-semibold py-3 px-6 rounded-lg"
                        }, 'ðŸ“š History (' + testHistory.length + ')')
                    ),
                    showTeacherMode && !isTeacherAuthenticated && e('div', { 
                        className: "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
                    },
                        e('div', { className: "bg-white rounded-lg p-6 max-w-sm w-full mx-4" },
                            e('h3', { className: "text-lg font-bold mb-4" }, "Teacher Mode"),
                            e('input', {
                                type: "password",
                                placeholder: "Password (teacher123)",
                                value: teacherPassword,
                                onChange: (evt) => setTeacherPassword(evt.target.value),
                                onKeyPress: (evt) => evt.key === 'Enter' && handleTeacherLogin(),
                                className: "w-full border rounded px-3 py-2 mb-4"
                            }),
                            e('div', { className: "flex gap-2" },
                                e('button', {
                                    onClick: handleTeacherLogin,
                                    className: "flex-1 bg-indigo-600 text-white py-2 rounded hover:bg-indigo-700"
                                }, "OK"),
                                e('button', {
                                    onClick: () => {
                                        setShowTeacherMode(false);
                                        setTeacherPassword('');
                                    },
                                    className: "flex-1 bg-gray-200 py-2 rounded hover:bg-gray-300"
                                }, "Cancel")
                            )
                        )
                    )
                );
            }

            // Loading screen
            if (stage === 'loading') {
                return e('div', { className: "min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4 flex items-center justify-center" },
                    e('div', { className: "bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full text-center" },
                        e('div', { className: "animate-spin rounded-full h-16 w-16 border-b-4 border-indigo-600 mx-auto mb-4" }),
                        e('h2', { className: "text-2xl font-bold text-gray-800 mb-2" }, "Generating..."),
                        e('p', { className: "text-gray-600" }, "Creating 25 questions (20-30 seconds)")
                    )
                );
            }

            // History screen
            if (showHistory) {
                const avgScore = testHistory.length > 0 
                    ? Math.round(testHistory.reduce((sum, t) => sum + t.score.percentage, 0) / testHistory.length)
                    : 0;
                const bestScore = testHistory.length > 0 ? Math.max(...testHistory.map(t => t.score.percentage)) : 0;

                return e('div', { className: "min-h-screen bg-gray-50 p-4" },
                    e('div', { className: "max-w-4xl mx-auto" },
                        e('div', { className: "bg-white rounded-lg shadow-md p-6 mb-6" },
                            e('div', { className: "flex justify-between items-center mb-6" },
                                e('h1', { className: "text-3xl font-bold text-gray-800" }, "ðŸ“š Test History"),
                                e('button', {
                                    onClick: () => setShowHistory(false),
                                    className: "bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded-lg"
                                }, "Back")
                            ),
                            e('div', { className: "grid md:grid-cols-3 gap-4 mb-6" },
                                e('div', { className: "bg-indigo-50 p-4 rounded-lg" },
                                    e('span', { className: "text-sm text-gray-600" }, "Total Tests"),
                                    e('p', { className: "text-2xl font-bold text-indigo-600" }, testHistory.length)
                                ),
                                e('div', { className: "bg-green-50 p-4 rounded-lg" },
                                    e('span', { className: "text-sm text-gray-600" }, "Average Score"),
                                    e('p', { className: "text-2xl font-bold text-green-600" }, avgScore + '%')
                                ),
                                e('div', { className: "bg-blue-50 p-4 rounded-lg" },
                                    e('span', { className: "text-sm text-gray-600" }, "Best Score"),
                                    e('p', { className: "text-2xl font-bold text-blue-600" }, bestScore + '%')
                                )
                            ),
                            e('div', { className: "flex gap-2 mb-6" },
                                e('button', {
                                    onClick: exportToJSON,
                                    className: "bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg"
                                }, "â¬‡ï¸ Export All"),
                                e('label', { className: "bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg cursor-pointer" },
                                    "â¬†ï¸ Import",
                                    e('input', { type: "file", accept: ".json", onChange: importFromJSON, className: "hidden" })
                                )
                            ),
                            testHistory.length === 0 
                                ? e('div', { className: "text-center py-12" },
                                    e('p', { className: "text-gray-500 text-6xl mb-4" }, "ðŸ“–"),
                                    e('p', { className: "text-gray-500" }, "No tests yet")
                                )
                                : e('div', { className: "space-y-3" },
                                    testHistory.map((test) =>
                                        e('div', { key: test.id, className: "border-2 border-gray-200 rounded-lg p-4" },
                                            e('div', { className: "flex justify-between items-start gap-4" },
                                                e('div', { className: "flex-1" },
                                                    e('h3', { className: "font-semibold text-gray-800 mb-2" }, test.title),
                                                    e('div', { className: "text-sm text-gray-600" },
                                                        'ðŸ“… ' + formatDate(test.timestamp) + ' | ',
                                                        'ðŸ† ' + test.score.percentage + '% | ',
                                                        'â±ï¸ ' + formatTime(test.timeTaken)
                                                    )
                                                ),
                                                e('div', { className: "flex gap-2" },
                                                    e('button', {
                                                        onClick: () => viewHistoryTest(test),
                                                        className: "bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm"
                                                    }, "View"),
                                                    e('button', {
                                                        onClick: () => deleteHistoryTest(test.id),
                                                        className: "bg-red-100 hover:bg-red-200 text-red-600 px-3 py-2 rounded-lg text-sm"
                                                    }, "Delete")
                                                )
                                            )
                                        )
                                    )
                                )
                        )
                    )
                );
            }

            // Quiz screen
            if (stage === 'quiz' && passage) {
                const groupedQuestions = {};
                passage.questions.forEach(q => {
                    if (!groupedQuestions[q.category]) groupedQuestions[q.category] = [];
                    groupedQuestions[q.category].push(q);
                });

                return e('div', { className: "min-h-screen bg-gray-50 p-4" },
                    e('div', { className: "max-w-4xl mx-auto" },
                        e('div', { className: "bg-white rounded-lg shadow-md p-4 mb-6 flex justify-between items-center sticky top-4 z-10" },
                            e('h1', { className: "text-xl font-bold" }, "Test"),
                            e('div', { className: "flex items-center gap-4" },
                                e('span', { className: "font-mono font-semibold text-indigo-600" }, 'â±ï¸ ' + formatTime(elapsedTime)),
                                e('button', {
                                    onClick: () => setShowTeacherMode(true),
                                    className: "text-sm text-gray-600 hover:text-indigo-600"
                                }, 'ðŸ‘¨â€ðŸ«')
                            )
                        ),
                        showTeacherMode && !isTeacherAuthenticated && e('div', { 
                            className: "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
                        },
                            e('div', { className: "bg-white rounded-lg p-6 max-w-sm w-full mx-4" },
                                e('h3', { className: "text-lg font-bold mb-4" }, "Teacher Mode"),
                                e('input', {
                                    type: "password",
                                    placeholder: "Password",
                                    value: teacherPassword,
                                    onChange: (evt) => setTeacherPassword(evt.target.value),
                                    className: "w-full border rounded px-3 py-2 mb-4"
                                }),
                                e('div', { className: "flex gap-2" },
                                    e('button', { onClick: handleTeacherLogin, className: "flex-1 bg-indigo-600 text-white py-2 rounded" }, "OK"),
                                    e('button', { onClick: () => setShowTeacherMode(false), className: "flex-1 bg-gray-200 py-2 rounded" }, "Cancel")
                                )
                            )
                        ),
                        e('div', { className: "bg-white rounded-lg shadow-md p-6 mb-6" },
                            e('h2', { className: "text-3xl font-bold text-gray-800 mb-6 text-center" }, passage.title),
                            e('div', { className: "mb-6" },
                                e('h3', { className: "text-xl font-semibold mb-3" }, "Introduction"),
                                e('p', { className: "text-gray-700 leading-relaxed whitespace-pre-line" }, passage.passage.introduction)
                            ),
                            passage.passage.sections.map((section, idx) =>
                                e('div', { key: idx, className: "mb-6" },
                                    e('h3', { className: "text-xl font-semibold mb-3" }, section.subtitle),
                                    e('p', { className: "text-gray-700 leading-relaxed whitespace-pre-line" }, section.content)
                                )
                            ),
                            e('div', { className: "mb-6" },
                                e('h3', { className: "text-xl font-semibold mb-3" }, "Conclusion"),
                                e('p', { className: "text-gray-700 leading-relaxed whitespace-pre-line" }, passage.passage.conclusion)
                            )
                        ),
                        e('div', { className: "bg-white rounded-lg shadow-md p-6 mb-6" },
                            e('h2', { className: "text-2xl font-bold mb-6" }, "Questions"),
                            Object.entries(groupedQuestions).map(([category, questions]) =>
                                e('div', { key: category, className: "mb-8" },
                                    e('h3', { className: "text-xl font-semibold text-indigo-600 mb-4" }, category),
                                    questions.map((q) =>
                                        e('div', { key: q.id, className: "mb-6 p-4 bg-gray-50 rounded-lg" },
                                            e('p', { className: "font-semibold text-gray-800 mb-3" }, q.id + '. ' + q.question),
                                            isTeacherAuthenticated && e('div', { className: "mb-3 p-3 bg-green-50 border-l-4 border-green-500" },
                                                e('p', { className: "text-sm font-semibold text-green-800" }, 'Answer: ' + q.correctAnswer + ')'),
                                                e('p', { className: "text-sm text-green-700 mt-1" }, q.explanation)
                                            ),
                                            e('div', { className: "space-y-2" },
                                                q.options.map((option, idx) => {
                                                    const letter = option.charAt(0);
                                                    const isSelected = answers[q.id] === letter;
                                                    return e('label', {
                                                        key: idx,
                                                        className: 'flex items-start p-3 rounded cursor-pointer ' + (isSelected ? 'bg-indigo-100 border-2 border-indigo-500' : 'bg-white border-2 border-gray-200 hover:border-indigo-300')
                                                    },
                                                        e('input', {
                                                            type: "radio",
                                                            name: 'q-' + q.id,
                                                            value: letter,
                                                            checked: isSelected,
                                                            onChange: () => handleAnswerChange(q.id, letter),
                                                            className: "mt-1 mr-3"
                                                        }),
                                                        e('span', null, option)
                                                    );
                                                })
                                            )
                                        )
                                    )
                                )
                            )
                        ),
                        e('div', { className: "bg-white rounded-lg shadow-md p-6 mb-6" },
                            e('button', {
                                onClick: handleSubmit,
                                disabled: Object.keys(answers).length !== passage.questions.length,
                                className: 'w-full py-4 rounded-lg font-semibold text-lg ' + (Object.keys(answers).length === passage.questions.length ? 'bg-indigo-600 hover:bg-indigo-700 text-white cursor-pointer' : 'bg-gray-300 text-gray-500 cursor-not-allowed')
                            },
                                Object.keys(answers).length === passage.questions.length
                                    ? 'Submit Test'
                                    : Object.keys(answers).length + '/' + passage.questions.length + ' Completed'
                            )
                        )
                    )
                );
            }

            // Results screen
            if (stage === 'results' && passage && score) {
                const groupedQuestions = {};
                passage.questions.forEach(q => {
                    if (!groupedQuestions[q.category]) groupedQuestions[q.category] = [];
                    groupedQuestions[q.category].push(q);
                });

                return e('div', { className: "min-h-screen bg-gray-50 p-4" },
                    e('div', { className: "max-w-4xl mx-auto" },
                        e('div', { className: "bg-white rounded-lg shadow-md p-8 mb-6 text-center" },
                            e('div', { className: "text-6xl mb-4" }, 'ðŸ†'),
                            e('h1', { className: "text-3xl font-bold mb-2" }, "Test Completed!"),
                            e('div', { className: "text-5xl font-bold text-indigo-600 mb-2" }, score.percentage + '%'),
                            e('p', { className: "text-lg text-gray-600 mb-4" }, score.correct + ' / ' + score.total + ' correct'),
                            e('div', { className: "text-gray-600" }, 'â±ï¸ ' + formatTime(elapsedTime))
                        ),
                        e('div', { className: "bg-white rounded-lg shadow-md p-6 mb-6" },
                            e('h2', { className: "text-2xl font-bold mb-6" }, "Review"),
                            Object.entries(groupedQuestions).map(([category, questions]) =>
                                e('div', { key: category, className: "mb-8" },
                                    e('h3', { className: "text-xl font-semibold text-indigo-600 mb-4" }, category),
                                    questions.map((q) => {
                                        const isCorrect = answers[q.id] === q.correctAnswer;
                                        return e('div', { 
                                            key: q.id, 
                                            className: 'mb-6 p-4 rounded-lg border-2 ' + (isCorrect ? 'bg-green-50 border-green-500' : 'bg-red-50 border-red-500')
                                        },
                                            e('div', { className: "flex items-start gap-3" },
                                                e('div', { className: "text-2xl flex-shrink-0" }, isCorrect ? 'âœ…' : 'âŒ'),
                                                e('div', { className: "flex-1" },
                                                    e('p', { className: "font-semibold mb-2" }, q.id + '. ' + q.question),
                                                    e('div', { className: "text-sm mb-3" },
                                                        e('p', { className: isCorrect ? 'text-green-700' : 'text-red-700' }, 'Your answer: ' + answers[q.id] + ')'),
                                                        !isCorrect && e('p', { className: "text-green-700" }, 'Correct: ' + q.correctAnswer + ')')
                                                    ),
                                                    e('div', { className: "bg-white p-3 rounded border" },
                                                        e('p', { className: "text-sm font-semibold mb-1" }, "Explanation:"),
                                                        e('p', { className: "text-sm text-gray-600" }, q.explanation)
                                                    )
                                                )
                                            )
                                        );
                                    })
                                )
                            )
                        ),
                        e('div', { className: "bg-white rounded-lg shadow-md p-6 mb-6" },
                            e('h2', { className: "text-2xl font-bold mb-6" }, "Vocabulary"),
                            e('div', { className: "grid gap-4" },
                                passage.vocabulary.map((item, idx) =>
                                    e('div', { key: idx, className: "p-4 bg-indigo-50 rounded-lg" },
                                        e('h4', { className: "font-bold text-indigo-900 mb-2" }, item.term),
                                        e('p', { className: "text-gray-700" }, item.definition)
                                    )
                                )
                            )
                        ),
                        e('div', { className: "bg-white rounded-lg shadow-md p-6 mb-6 flex gap-4" },
                            e('button', {
                                onClick: () => {
                                    setStage('start');
                                    setAnswers({});
                                    setScore(null);
                                    setPassage(null);
                                    setElapsedTime(0);
                                },
                                className: "flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 rounded-lg"
                            }, "New Test"),
                            e('button', {
                                onClick: () => setShowHistory(true),
                                className: "flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-3 rounded-lg"
                            }, "ðŸ“š History")
                        )
                    )
                );
            }

            return null;
        }

            ReactDOM.render(e(ReadingQuizApp), document.getElementById('root'));
        })();
    </script>
</body>
</html>
