<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English Quiz System</title>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    
    <script>
        const { createElement: e, useState, useEffect } = React;
        
        // Simple Icon component
        const Icon = ({ d, ...props }) => 
            e('svg', { xmlns: "http://www.w3.org/2000/svg", width: 24, height: 24, viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: 2, ...props },
                e('path', { d }));

        function App() {
            const [mode, setMode] = useState('start');
            const [studentName, setStudentName] = useState('');
            const [teacherAuth, setTeacherAuth] = useState(false);
            const [passwordInput, setPasswordInput] = useState('');
            const [tests, setTests] = useState([]);
            const [selectedTest, setSelectedTest] = useState(null);
            const [answers, setAnswers] = useState({});
            const [startTime, setStartTime] = useState(null);
            const [elapsedTime, setElapsedTime] = useState(0);
            const [results, setResults] = useState([]);
            const [showPasswordModal, setShowPasswordModal] = useState(false);
            const [isGenerating, setIsGenerating] = useState(false);
            const [isLoading, setIsLoading] = useState(false);
            const [selectedResult, setSelectedResult] = useState(null);
            const [feedback, setFeedback] = useState('');
            const [loadingFeedback, setLoadingFeedback] = useState(false);

            const TEACHER_PASSWORD = 'teacher123';
            const API_KEY = 'AIzaSyC6bbcJoqNKVkSFPwyL_cArNT0L1Wn-CFs';
            const SPREADSHEET_ID = '1VA0H-1eixnvsArTEi-aZxzkCjnexjEBZJaREpyWvI-g';

            const appendToSheet = async (sheetName, values) => {
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${sheetName}!A:Z:append?valueInputOption=RAW&key=${API_KEY}`;
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ values: [values] })
                });
                return await response.json();
            };

            const readFromSheet = async (sheetName) => {
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${sheetName}!A:Z?key=${API_KEY}`;
                const response = await fetch(url);
                const data = await response.json();
                return data.values || [];
            };

            const loadData = async () => {
                setIsLoading(true);
                try {
                    const testsData = await readFromSheet('Tests');
                    if (testsData.length > 1) {
                        setTests(testsData.slice(1).map(row => ({
                            id: parseInt(row[0]),
                            title: row[1],
                            data: JSON.parse(row[2]),
                            createdAt: parseInt(row[3])
                        })));
                    }
                    const resultsData = await readFromSheet('Results');
                    if (resultsData.length > 1) {
                        setResults(resultsData.slice(1).map(row => ({
                            id: parseInt(row[0]),
                            studentName: row[1],
                            testId: parseInt(row[2]),
                            testTitle: row[3],
                            timestamp: parseInt(row[4]),
                            timeTaken: parseInt(row[5]),
                            score: parseInt(row[6]),
                            correct: parseInt(row[7]),
                            total: parseInt(row[8]),
                            answers: JSON.parse(row[9])
                        })));
                    }
                    alert('Data loaded!');
                } catch (error) {
                    alert('Error loading data');
                } finally {
                    setIsLoading(false);
                }
            };

            useEffect(() => { loadData(); }, []);

            useEffect(() => {
                let interval;
                if (mode === 'quiz' && startTime) {
                    interval = setInterval(() => {
                        setElapsedTime(Math.floor((Date.now() - startTime) / 1000));
                    }, 1000);
                }
                return () => clearInterval(interval);
            }, [mode, startTime]);

            const formatTime = (s) => `${Math.floor(s/60)}:${String(s%60).padStart(2,'0')}`;
            const formatDate = (t) => new Date(t).toLocaleString('ko-KR');

            const generateTest = async () => {
                setIsGenerating(true);
                try {
                    const response = await fetch("https://api.anthropic.com/v1/messages", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            model: "claude-sonnet-4-20250514",
                            max_tokens: 8000,
                            messages: [{ role: "user", content: "Generate a Year 9 level reading comprehension test in JSON format with: {title, passage: {introduction, sections: [{subtitle, content}], conclusion}, questions: [{id, category, question, options, correctAnswer, explanation}], vocabulary: [{term, definition}]}. 10-14 questions, 10-15 vocab. NO MARKDOWN." }]
                        })
                    });
                    const data = await response.json();
                    const testData = JSON.parse(data.content[0].text.replace(/```json\n?/g, "").replace(/```\n?/g, "").trim());
                    const newTest = { id: Date.now(), title: testData.title, createdAt: Date.now(), data: testData };
                    await appendToSheet('Tests', [newTest.id, newTest.title, JSON.stringify(newTest.data), newTest.createdAt]);
                    setTests([newTest, ...tests]);
                    alert('Test created!');
                } catch (error) {
                    alert('Error creating test');
                } finally {
                    setIsGenerating(false);
                }
            };

            const submitAnswers = async () => {
                if (Object.keys(answers).length !== selectedTest.data.questions.length) {
                    alert('Answer all questions!');
                    return;
                }
                let correct = 0;
                selectedTest.data.questions.forEach(q => {
                    if (answers[q.id] === q.correctAnswer) correct++;
                });
                const result = {
                    id: Date.now(),
                    studentName,
                    testId: selectedTest.id,
                    testTitle: selectedTest.title,
                    timestamp: Date.now(),
                    timeTaken: elapsedTime,
                    score: Math.round((correct / selectedTest.data.questions.length) * 100),
                    correct,
                    total: selectedTest.data.questions.length,
                    answers
                };
                await appendToSheet('Results', [result.id, result.studentName, result.testId, result.testTitle, result.timestamp, result.timeTaken, result.score, result.correct, result.total, JSON.stringify(result.answers)]);
                setResults([result, ...results]);
                setMode('results');
            };

            if (mode === 'start') {
                return e('div', { className: "min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-6 flex items-center justify-center" },
                    e('div', { className: "bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full" },
                        e('div', { className: "text-center mb-8" },
                            e('div', { className: "text-6xl mb-4" }, 'ðŸ“š'),
                            e('h1', { className: "text-3xl font-bold text-gray-800 mb-2" }, "English Quiz System"),
                            e('p', { className: "text-gray-600" }, "Google Sheets Connected")
                        ),
                        e('div', { className: "space-y-4" },
                            e('button', {
                                onClick: () => setMode('student'),
                                className: "w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-4 px-6 rounded-lg"
                            }, "Student Mode"),
                            e('button', {
                                onClick: () => setShowPasswordModal(true),
                                className: "w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-4 px-6 rounded-lg"
                            }, "Teacher Mode"),
                            e('button', {
                                onClick: loadData,
                                disabled: isLoading,
                                className: "w-full bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-3 px-6 rounded-lg"
                            }, isLoading ? 'Loading...' : 'Refresh Data')
                        )
                    ),
                    showPasswordModal && e('div', { className: "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" },
                        e('div', { className: "bg-white rounded-lg p-6 max-w-sm w-full mx-4" },
                            e('h3', { className: "text-lg font-bold mb-4" }, "Teacher Login"),
                            e('input', {
                                type: "password",
                                placeholder: "Password",
                                value: passwordInput,
                                onChange: (e) => setPasswordInput(e.target.value),
                                className: "w-full border-2 rounded-lg px-4 py-2 mb-4"
                            }),
                            e('div', { className: "flex gap-2" },
                                e('button', {
                                    onClick: () => {
                                        if (passwordInput === TEACHER_PASSWORD) {
                                            setTeacherAuth(true);
                                            setMode('teacherDash');
                                            setShowPasswordModal(false);
                                        } else {
                                            alert('Wrong password');
                                        }
                                    },
                                    className: "flex-1 bg-indigo-600 text-white py-2 rounded-lg"
                                }, "OK"),
                                e('button', {
                                    onClick: () => setShowPasswordModal(false),
                                    className: "flex-1 bg-gray-200 py-2 rounded-lg"
                                }, "Cancel")
                            )
                        )
                    )
                );
            }

            if (mode === 'student') {
                return e('div', { className: "min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-6 flex items-center justify-center" },
                    e('div', { className: "bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full" },
                        e('button', { onClick: () => setMode('start'), className: "mb-6" }, "â† Back"),
                        e('div', { className: "text-center mb-8" },
                            e('div', { className: "text-6xl mb-4" }, 'ðŸ‘‹'),
                            e('h2', { className: "text-2xl font-bold" }, "Enter Your Name")
                        ),
                        e('input', {
                            type: "text",
                            placeholder: "Name",
                            value: studentName,
                            onChange: (e) => setStudentName(e.target.value),
                            className: "w-full border-2 rounded-lg px-4 py-3 mb-4"
                        }),
                        e('button', {
                            onClick: () => studentName.trim() && setMode('selectTest'),
                            className: "w-full bg-indigo-600 text-white py-3 rounded-lg"
                        }, "Next")
                    )
                );
            }

            if (mode === 'selectTest') {
                return e('div', { className: "min-h-screen bg-gray-50 p-6" },
                    e('div', { className: "max-w-4xl mx-auto" },
                        e('div', { className: "bg-white rounded-lg shadow-md p-6 mb-6" },
                            e('h2', { className: "text-2xl font-bold" }, `Hello, ${studentName}!`),
                            e('button', {
                                onClick: () => { setStudentName(''); setMode('student'); },
                                className: "text-gray-600 mt-2"
                            }, "Logout")
                        ),
                        tests.length === 0 ? 
                            e('div', { className: "bg-white rounded-lg p-12 text-center" },
                                e('p', null, "No tests available")
                            ) :
                            e('div', { className: "space-y-4" },
                                tests.map(test =>
                                    e('div', {
                                        key: test.id,
                                        onClick: () => {
                                            setSelectedTest(test);
                                            setAnswers({});
                                            setStartTime(Date.now());
                                            setMode('quiz');
                                        },
                                        className: "bg-white rounded-lg p-6 cursor-pointer hover:shadow-lg"
                                    },
                                        e('h3', { className: "text-xl font-bold mb-2" }, test.title),
                                        e('p', { className: "text-sm text-gray-600" }, `${test.data.questions.length} questions`)
                                    )
                                )
                            )
                    )
                );
            }

            if (mode === 'quiz' && selectedTest) {
                const progress = (Object.keys(answers).length / selectedTest.data.questions.length) * 100;
                return e('div', { className: "min-h-screen bg-gray-50 p-4" },
                    e('div', { className: "max-w-4xl mx-auto" },
                        e('div', { className: "bg-white rounded-lg p-4 mb-6 sticky top-4" },
                            e('div', { className: "flex justify-between mb-2" },
                                e('h2', { className: "font-bold" }, selectedTest.title),
                                e('span', null, formatTime(elapsedTime))
                            ),
                            e('div', { className: "w-full bg-gray-200 rounded-full h-2" },
                                e('div', { className: "bg-indigo-600 h-2 rounded-full", style: { width: `${progress}%` } })
                            )
                        ),
                        e('div', { className: "bg-white rounded-lg p-6 mb-6" },
                            e('h3', { className: "text-2xl font-bold mb-4" }, "Reading Passage"),
                            e('p', { className: "mb-4" }, selectedTest.data.passage.introduction),
                            selectedTest.data.passage.sections.map((s, i) =>
                                e('div', { key: i, className: "mb-4" },
                                    e('h4', { className: "font-semibold mb-2" }, s.subtitle),
                                    e('p', null, s.content)
                                )
                            ),
                            e('p', null, selectedTest.data.passage.conclusion)
                        ),
                        e('div', { className: "bg-white rounded-lg p-6 mb-6" },
                            selectedTest.data.questions.map(q =>
                                e('div', { key: q.id, className: "mb-6 p-4 bg-gray-50 rounded-lg" },
                                    e('p', { className: "font-semibold mb-3" }, `${q.id}. ${q.question}`),
                                    e('div', { className: "space-y-2" },
                                        q.options.map((opt, i) => {
                                            const letter = opt.charAt(0);
                                            return e('label', {
                                                key: i,
                                                className: `flex items-start p-3 rounded-lg cursor-pointer ${answers[q.id] === letter ? 'bg-indigo-100 border-2 border-indigo-500' : 'bg-white border-2'}`
                                            },
                                                e('input', {
                                                    type: "radio",
                                                    checked: answers[q.id] === letter,
                                                    onChange: () => setAnswers({...answers, [q.id]: letter}),
                                                    className: "mr-3"
                                                }),
                                                e('span', null, opt)
                                            );
                                        })
                                    )
                                )
                            )
                        ),
                        e('button', {
                            onClick: submitAnswers,
                            disabled: Object.keys(answers).length !== selectedTest.data.questions.length,
                            className: "w-full bg-indigo-600 text-white py-4 rounded-lg font-semibold disabled:bg-gray-300"
                        }, "Submit Test")
                    )
                );
            }

            if (mode === 'results' && results[0]) {
                const result = results[0];
                const test = tests.find(t => t.id === result.testId);
                return e('div', { className: "min-h-screen bg-gray-50 p-4" },
                    e('div', { className: "max-w-4xl mx-auto" },
                        e('div', { className: "bg-white rounded-lg p-8 mb-6 text-center" },
                            e('div', { className: "text-6xl mb-4" }, result.score >= 70 ? 'ðŸŽ‰' : 'ðŸ’ª'),
                            e('h2', { className: "text-3xl font-bold mb-2" }, `${studentName}'s Result`),
                            e('div', { className: "text-5xl font-bold text-indigo-600 mb-2" }, `${result.score}%`),
                            e('p', null, `${result.correct} / ${result.total} correct`)
                        ),
                        e('div', { className: "flex gap-4" },
                            e('button', {
                                onClick: () => { setStudentName(''); setMode('student'); },
                                className: "flex-1 bg-indigo-600 text-white py-3 rounded-lg"
                            }, "Take Another Test"),
                            e('button', {
                                onClick: () => { setStudentName(''); setMode('start'); },
                                className: "flex-1 bg-gray-200 py-3 rounded-lg"
                            }, "Home")
                        )
                    )
                );
            }

            if (mode === 'teacherDash' && teacherAuth) {
                const avgScore = results.length > 0 ? Math.round(results.reduce((sum, r) => sum + r.score, 0) / results.length) : 0;
                return e('div', { className: "min-h-screen bg-gray-50 p-6" },
                    e('div', { className: "max-w-6xl mx-auto" },
                        e('div', { className: "bg-white rounded-lg p-6 mb-6" },
                            e('h1', { className: "text-3xl font-bold" }, "Teacher Dashboard"),
                            e('button', {
                                onClick: () => { setTeacherAuth(false); setMode('start'); },
                                className: "mt-2"
                            }, "Logout")
                        ),
                        e('div', { className: "grid md:grid-cols-4 gap-4 mb-6" },
                            e('div', { className: "bg-white rounded-lg p-6" },
                                e('p', { className: "text-gray-600" }, "Total Tests"),
                                e('p', { className: "text-3xl font-bold text-indigo-600" }, tests.length)
                            ),
                            e('div', { className: "bg-white rounded-lg p-6" },
                                e('p', { className: "text-gray-600" }, "Students"),
                                e('p', { className: "text-3xl font-bold text-green-600" }, new Set(results.map(r => r.studentName)).size)
                            ),
                            e('div', { className: "bg-white rounded-lg p-6" },
                                e('p', { className: "text-gray-600" }, "Attempts"),
                                e('p', { className: "text-3xl font-bold text-blue-600" }, results.length)
                            ),
                            e('div', { className: "bg-white rounded-lg p-6" },
                                e('p', { className: "text-gray-600" }, "Avg Score"),
                                e('p', { className: "text-3xl font-bold text-purple-600" }, `${avgScore}%`)
                            )
                        ),
                        e('div', { className: "bg-white rounded-lg p-6 mb-6" },
                            e('button', {
                                onClick: generateTest,
                                disabled: isGenerating,
                                className: "w-full bg-indigo-600 text-white py-4 rounded-lg font-semibold"
                            }, isGenerating ? 'Generating...' : 'Generate New Test')
                        ),
                        e('div', { className: "bg-white rounded-lg p-6" },
                            e('h3', { className: "text-xl font-bold mb-4" }, "Recent Tests"),
                            tests.slice(0, 5).map(test =>
                                e('div', { key: test.id, className: "p-4 border-b" },
                                    e('h4', { className: "font-bold" }, test.title),
                                    e('p', { className: "text-sm text-gray-600" }, formatDate(test.createdAt))
                                )
                            )
                        )
                    )
                );
            }

            return null;
        }

        ReactDOM.render(e(App), document.getElementById('root'));
    </script>
</body>
</html>
